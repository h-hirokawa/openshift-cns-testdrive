= クラスタのメータリング
:experimental:

== 演習の概要
この演習は、システム管理者とアプリケーション開発者の両方で、Metering OperatorとReportのデプロイと管理方法を学びたい方を対象としています。

この演習では、以下の方法を学びます

* OperatorHubからMetering Operatorのデプロイ 
* Metering stackのインストール
* インストールの確認
* Reportの作成
* Reportの読み方

---

=== 背景

OpenShift Container Platform (OCP) 4.2では、Operator MeteringがGAになりました。 +
Operator Meteringは、クラスタ全体でリソースがどのように使用されたかを提供する、チャージバックおよびReportのツールです。 +
クラスタ管理者は、*Pod*、*Namespace*、およびクラスタ全体の過去の使用データに基づいて、Reportをスケジュールすることができます。 +
Operator Meteringはlink:https://coreos.com/blog/introducing-operator-framework-metering[Operator Framework]の一部です。

[Note]
====
この演習はCLIとOpenShiftのWebコンソールを両方で行います。Webコンソールとのインタラクションはすべて、事実上バックグラウンドでAPIオブジェクトを操作しています。 +
プロセスを完全に自動化したり、CLIや他のツールを使用して行うことも可能ですが、これらの方法は現時点では演習やドキュメントではカバーされていません。
====

=== Operator Metering のインストール

<<<<<<< HEAD
==== Cluster Projects の確認
=======
[Note]
====
This lab assumes you have logged into an existing cluster with the `oc login` command
====
>>>>>>> upstream/ocp4-dev

`oc projects` コマンドを実行して、既存のクラスタ内の *Project* を表示します(これは `kubectl namespace` と似ています)。出力で `openshift-metering` を検索してください。

[source,bash,role="execute"]
----
oc projects | grep openshift-metering
----

現在 Metering の *Project* は存在しないことが出力されているはずです。

==== OpenShift Webコンソールへのログイン

{{ MASTER_URL }}[OpenShift Webコンソール] にkubeadminでログインします。

[source,role="copypaste"]
----
kubeadmin
----

[source,role="copypaste"]
----
{{ KUBEADMIN_PASSWORD }}
----

[Warning]
====
<<<<<<< HEAD
OpenShift Webコンソールに初めてアクセスすると、ブラウザに自己署名証明書エラーが表示されます。 +
OpenShiftをインストールすると、デフォルトでは、Webコンソールを含むOpenShift内のすべてのコンポーネント間通信に対してCAとSSL証明書が生成されます。
=======
You might receive a self-signed certificate error in your browser when you
first visit the OpenShift Web console. When OpenShift is installed, by default, a CA
and SSL certificates are generated for all inter-component communication
within OpenShift, including the web console.
>>>>>>> upstream/ocp4-dev
====

#### クラスタにMetering Operatorをインストール
OpenShift Webコンソールを使用してMetering Operatorをインストールするには、まず `openshift-metering` Namespaceを作成し、OperatorHubからMetering Operatorをインストールします。

1. OpenShift Container PlatformのWebコンソールで、*Administration* → *Namespaces* → *Create Namespace* をクリックします。

<<<<<<< HEAD
2. 名前を `openshift-metering` に設定します。他の名前ではサポートされませんので注意して下さい。 +
Namespace に以下のLabelを付けます。
=======
1. In the OpenShift Container Platform web console, click *Administration* → *Namespaces* → *Create Namespace*.

2. Set the name to `openshift-metering` and make sure to label the namespace with 
>>>>>>> upstream/ocp4-dev
+
[source,role="copypaste"]
----
openshift.io/cluster-monitoring=true
----
+
*Create* をクリックします。

<<<<<<< HEAD
3. 次に、 *Operators* → *OperatorHub* をクリックし、`Metering` とフィルタリングしてMetering Operatorを探します。
=======
3. Next, click *Operators* → *OperatorHub*, and filter for `metering` to find the Metering Operator.
+
image::images/metering-operator-image.png[Metering Operator Logo]
>>>>>>> upstream/ocp4-dev

4. *Metering* のカードをクリックし、パッケージの説明を確認してから、*Install* をクリックします。

<<<<<<< HEAD
5. *Install Operator* の画面にて、Update Channelに `4.5` を指定し、上記で作成した `openshift-metering` Namespace を選択します。 +
Approval Strategyに `Automatic` を指定したら、*Install* をクリックします。

6. *Installed Operators* の画面で、Metering Operatorのインストールが終わると、*Status* に *Succeeded* と表示されます。 +
表示される名前(Metering) をクリックすることで、*Operator Details* のページを見ることができます。
=======
5. On the *Install Operator* screen, make sure the `4.6` *Update Channel* is selected. Also, verify that `A specific namespace on the cluster` is selected as the *Installation Mode*. The *Installed Namespace* should already be set  to `Operator recommended namespace` with `openshift-metering` selected. Keep the *Approval Strategy* to `Automatic`.
+
image::images/metering-install-operator.png[Metering Operator Install]
+
Once you've verified these options, click "Install".

6. This will take you the the "Installing Operator" progress page.
+
image::images/metering-installing-progress.png[Metering Operator Install Progress]
+
Once the page displays *Installed operator - ready for use*, go ahead and click on `View Operator`.

7. This will take you to the *Operator Details* page.
+
image::images/metering-details-page.png[Metering Operator Install Progress]

>>>>>>> upstream/ocp4-dev

[Note]
====
<<<<<<< HEAD
Metering Operatorのインストールには、数分かかる場合があります。
=======
It may take a few minutes for the metering operator to install, be patient.
>>>>>>> upstream/ocp4-dev
====

### Metering stackのインストール

<<<<<<< HEAD
1. `openshift-metering` *Project* で、Metering Operatorの *Operator Details* ページにいることを確認して下さい。 +
このページに移動するには、*Operators* → *Installed Operators* とクリックして、Metering Operatorを選択します。

2. *Provided APIs* の一覧から、 *Metering Configuration* カードを探し出し、*Create Instance* をクリックします。 +
`Configure via` で `YAML View` を指定すると、デフォルトのMeteringConfigファイルを持つYAMLエディタが開きます。

3. 以下のMeteringConfigをYAMLエディタにコピーして貼り付け、*Create* をクリックして、デフォルトの構成を置き換えます。
=======
1. From the web console, ensure you are on the *Operator Details* page for the Metering Operator in the `openshift-metering` project. If you've navigated away from this page, you can get back to this page by clicking *Operators* → *Installed Operators*, then selecting the Metering Operator.

2. Under *Provided APIs*, click *Create Instance* on the **Metering Configuration** card.
+
image::images/metering-config-card.png[Metering Config Card]

3. Click on *YAML View* in the *Configure via* section; and replace the default configuration by copying and pasting the following MeteringConfig into the YAML editor and click `Create`:
>>>>>>> upstream/ocp4-dev
+
[source,role="copypaste"]
----
apiVersion: metering.openshift.io/v1
kind: MeteringConfig
metadata:
  name: "operator-metering"
spec:
  unsupportedFeatures:
    enableHDFS: true
  storage:
    type: "hive"
    hive:
      type: "hdfs"
      hdfs:
        # Leave this value as-is.
        namenode: "hdfs-namenode-0.hdfs-namenode:9820"
----
+
WARNING: このラボでは、OpenShift Container Storageへの依存関係を作らないようにするために、Metering Operatorが独自にデプロイする、サポートされていないストレージ構成であるHDFSを使用します。

### インストールの確認

必要な *Pod* がすべて作成されていることを確認することで、Reportデータソースがデータのインポートを開始していることを確認します。

1. `openshift-metering` Namespace で *Workloads* → *Pods* と移動し、*Pod* が作成されていることを確認します。 +
これは、Metering Stackをインストールから数分かかることがあります。
+
`oc` CLIを使用しても同様のチェックができます。
+
[source,bash,role="execute"]
----
oc -n openshift-metering get pods
----
+
以下のように表示されます。
+
----
NAME                                  READY   STATUS              RESTARTS   AGE
hive-metastore-0                      1/2     Running             0          52s
hive-server-0                         2/3     Running             0          52s
metering-operator-68dd64cfb6-pxh8v    2/2     Running             0          2m49s
presto-coordinator-0                  2/2     Running             0          31s
reporting-operator-56c6c878fb-2zbhp   0/2     ContainerCreating   0          4s
----

2. *Pod* が `Ready` と表示されるまでチェックを続けます。これには数分かかることがあります。 +
多くの *Pod* では、それ自体がReadyとみなされる前に他のコンポーネントの機能に依存しています。他の *Pod* の起動に時間がかかりすぎると、一部の *Pod* が再起動することがあります。これは問題ではなく、インストール中に予期される動作です。
+
<<<<<<< HEAD
`oc` CLIで同様のチェックをすると次のような出力が表示されます。

=======
You can follow the instantiation of the Pods by waiting for all the `StatefulSet` rollouts:
+
[source,bash,role="execute"]
----
until [[ $(oc get sts -n openshift-metering -o name | wc -l) -gt 4 ]]; do echo "waiting for statefulsets..." ; sleep 10 ; done
oc rollout status sts/hdfs-datanode -n openshift-metering
oc rollout status sts/hdfs-namenode -n openshift-metering
oc rollout status sts/hive-metastore -n openshift-metering
oc rollout status sts/hive-server -n openshift-metering
oc rollout status sts/presto-coordinator -n openshift-metering
oc rollout status sts/presto-worker -n openshift-metering
----
+
Once done, you can use the `oc` CLI, to see them running:
>>>>>>> upstream/ocp4-dev
+
[source,bash,role="execute"]
----
oc -n openshift-metering get pods
----
+
----
NAME                                  READY   STATUS    RESTARTS   AGE
hdfs-datanode-0                       1/1     Running   0          6m32s
hdfs-namenode-0                       1/1     Running   0          6m32s
hive-metastore-0                      2/2     Running   0          6m9s
hive-server-0                         3/3     Running   0          6m9s
metering-operator-6f7fb6f6fd-dfk6w    1/1     Running   0          22m
presto-coordinator-0                  2/2     Running   0          5m43s
reporting-operator-57c5b4d577-flsqb   2/2     Running   0          5m13s
----

3. 次に、`oc` CLIを使用して、ReportDataSourcesがデータのインポートを開始していることを確認します。 +
これは下のコマンドの出力で、`EARLIEST METRIC`列に有効なタイムスタンプが表示されることで示されます(これには数分かかる場合があります)。 +
データをインポートしない「-raw」ReportDataSourcesをフィルタリングします。
+
[source,bash,role="execute"]
----
oc get reportdatasources -n openshift-metering | grep -v raw
----

すべての *Pod* の準備が整い、データがインポートされていることを確認したら、Meteringを使用してデータを収集し、クラスタのReportを作成することができます。

### Reportの作成

Report Custom Resourceは、Reportの実行とステータスを管理するために使用されます。 +
使用量のデータソースから派生したReportを生成し、さらなる分析やフィルタリングに使用することができます。

<<<<<<< HEAD
1つのReport Resourceは、データベーステーブルを管理し、スケジュールに従って新しい情報に更新するジョブを表します。 +
Reportは、Reporting-OperatorのHTTP APIを介して、そのテーブルのデータを公開します。`spec.schedule` フィールドが設定されたReportは常に実行されており、データを収集した期間をトラッキングします。 +
これにより、Meteringがシャットダウンされたり、長期間使用できない場合でも、データは中断されたところからbackfillされることが保証されます。
=======
A single Report resource represents a job that manages a database table and updates it with new information according to a schedule. The Report exposes the data in that table via the reporting-operator HTTP API. Reports with a `spec.schedule` field set are always running and track what time periods it has collected data for. This ensures that if metering is shutdown or unavailable for an extended period of time, it will backfill the data starting where it left off. If the schedule is unset, then the Report will run once for the time specified by the `reportingStart` and `reportingEnd`.

By default, reports wait for `ReportDataSources` to have fully imported any data covered in the reorting peroid. If the Report has a schedule, it will wait to run until the data in the period currently being processed has finished importing.
>>>>>>> upstream/ocp4-dev

スケジュールが設定されていない場合、Reportは `reportingStart` と `reportingEnd` で指定された時間だけ実行されます。 +
デフォルトでは、ReportはReportDataSourcesが期間に含まれるデータが完全にインポートされるのを待ちます。 +
Reportにスケジュールがある場合、現在処理されている期間のデータがインポートを終了するまで実行を待ちます。

`oc` CLIを使用して、どのようなReportが利用可能かを確認するために、ReportQueriesを取得します。

[source,bash,role="execute"]
----
oc get reportqueries -n openshift-metering | grep -v raw
----

<<<<<<< HEAD
後に `-raw` の付くReportQueriesは、より複雑なクエリを構築するために他のReportQueriesによって使用されるものです。Reportに直接使用されるべきではありません。
=======
[Note]
====
ReportQueries with the `-raw` suffix are used by other ReportQueries to build more complex queries, and should not be used directly for reports. Therefore, we omitted them with the `grep -v raw` command.
====
>>>>>>> upstream/ocp4-dev

#### スケジュールを使ったReportの作成

以下の操作で作成するReportには、すべての *Pod* のCPUリクエストに関する情報が含まれており、1時間ごとに実行され、実行するたびに最後の1時間分のデータが追加されます。

<<<<<<< HEAD
1. OpenShift Container PlatformのWebコンソールで、*Operators* → *Installed Operators* をクリックします。*Installed Operators* でMetering Operatorをクリックします。

2. *Metering Report* カードで *Create Instance* をクリックします。これにより、構成を定義するデフォルトのMeteringConfigファイルを持つYAMLエディタが開きます。
=======
1. In the OpenShift Container Platform web console, click *Operators* → *Installed Operators*. On the *Installed Operators* click the Metering operator. This will bring you to the details page again.
+
image::images/metering-details-page.png[Metering Details Page]

2. Under the *Metering Report* card, click *Create Instance*.
+
image::images/metering-report-card.png[Metering Report card]
+
This opens the *Create Report* page. Click `YAML View` to get the YAML editor
>>>>>>> upstream/ocp4-dev

3. YAMLエディタで以下のMeteringConfigにコピーして貼り付け、デフォルトの構成を置き換えます
。*Create* をクリックします。
+
[source,role="copypaste"]
----
apiVersion: metering.openshift.io/v1
kind: Report
metadata:
  name: cluster-cpu-usage-hourly
spec:
  query: "cluster-cpu-usage"
  schedule:
    period: "hourly"
----

4. 次に、`oc` CLIを使用してReportが作成されたことを確認します。
+
[source,bash,role="execute"]
----
oc get reports -n openshift-metering
---- 
+
以下のような出力が表示されます。
+
----
NAME                       QUERY               SCHEDULE   RUNNING                  FAILED   LAST REPORT TIME   AGE
cluster-cpu-usage-hourly   cluster-cpu-usage   hourly     ReportingPeriodWaiting                               7s
----

5. 構成した時間(1時間)が経過すると、Reportが実行されます。このまま置いて進めてみましょう。

#### ワンタイムレポートの作成

以下の例では、すべてのNamespaceのCPUリクエストに関する情報を含むReportが1回実行されます。

<<<<<<< HEAD
1. OpenShift Container PlatformのWebコンソールで、*Operators* → *Installed Operators* をクリックします。*Installed Operators* でMetering Operatorをクリックします。

2. *Metering Report* カードで *Create Instance* をクリックします。これにより、構成を定義するデフォルトのMeteringConfigファイルを持つYAMLエディタが開きます。
=======
1. In the OpenShift Container Platform web console, click *Operators* → *Installed Operators*. On the *Installed Operators* click the Metering operator. This will, once again, bring you to the details page.
+
image::images/metering-details-page.png[Metering Details Page]

2. Under the *Metering Report* card, click *Create Instance*.
+
image::images/metering-report-card.png[Metering Report card]
+
This opens the *Create Report* page. Click `YAML View` to get the YAML editor
>>>>>>> upstream/ocp4-dev

3. YAMLエディタで以下のMeteringConfigにコピーして貼り付け、デフォルトの構成を置き換えます
。*Create* をクリックします。
+
[source,role="copypaste"]
----
apiVersion: metering.openshift.io/v1
kind: Report
metadata:
  name: namespace-cpu-request-2020
  namespace: openshift-metering
spec:
  query: namespace-cpu-request
  reportingEnd: '2025-12-30T23:59:59Z'
  reportingStart: '2020-01-01T00:00:00Z'
  runImmediately: true
----

4. 次に、`oc` CLIを使用してReportが作成されたことを確認します。
+
[source,bash,role="execute"]
----
oc get reports -n openshift-metering
----
+
以下のような出力が表示されます。
+
----
NAME                         QUERY                   SCHEDULE   RUNNING                  FAILED   LAST REPORT TIME       AGE
cluster-cpu-usage-hourly     cluster-cpu-usage       hourly     ReportingPeriodWaiting                                   4m37s
namespace-cpu-request-2020   namespace-cpu-request              Finished                          2020-12-30T23:59:59Z   28s
----

### Reportの表示
Reportを表示するには、以下の手順を実行します。

<<<<<<< HEAD
1. OpenShift Container PlatformのWebコンソールで、*Administration* → *Chargeback* をクリックします。

2. 前のセクションで作成したワンタイムレポート(namespace-cpu-request-2020)を選択します。

3. この画面で *Download* ボタンをクリックすることで、ReportをCSVファイルとしてダウンロードすることができます。また、Reportは画面下部にも表示されます。
=======
1. In the OpenShift Container Platform web console, click *Administration* → *Chargeback*. This opens the `Chargeback Reporting` page.
+
image::images/chargeback-rep.png[Chargeback Reporting]

2. Select the one-time report created in the previous section titled `namespace-cpu-request-2020`

3. From this screen the report can be downloaded as a CSV file by scolling down, and clicking the Download button. The report is also displayed in the lower part of the screen.
+
image::images/download-csv.png[Download CSV]
+
This file can be imported to any metering application that accepts CSV format.
>>>>>>> upstream/ocp4-dev
